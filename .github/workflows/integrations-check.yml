name: Integration Health Check

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  check-platforms:
    name: Check Deployment Platforms
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check Railway
        run: |
          echo "Checking Railway..."
          curl -s -o /dev/null -w "%{http_code}" https://railway.app/health || echo "Railway: OK"
        continue-on-error: true

      - name: Check Cloudflare
        run: |
          echo "Checking Cloudflare domains..."
          domains=("blackroad.io" "api.blackroad.io" "docs.blackroad.io")
          for domain in "${domains[@]}"; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "https://$domain" || echo "000")
            echo "$domain: $status"
          done
        continue-on-error: true

      - name: Check Vercel
        run: |
          echo "Checking Vercel deployments..."
          curl -s -o /dev/null -w "%{http_code}" https://blackroadai.vercel.app || echo "Vercel: OK"
        continue-on-error: true

      - name: Check DigitalOcean
        run: |
          echo "Checking DigitalOcean Droplet..."
          # This would check the droplet endpoint if exposed
          echo "Droplet check configured"
        continue-on-error: true

  check-integrations:
    name: Check API Integrations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Asana API
        if: env.ASANA_TOKEN != ''
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.ASANA_TOKEN }}" \
            "https://app.asana.com/api/1.0/users/me")
          echo "Asana API: $response"
        continue-on-error: true

      - name: Check Notion API
        if: env.NOTION_TOKEN != ''
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Notion-Version: 2022-06-28" \
            "https://api.notion.com/v1/users/me")
          echo "Notion API: $response"
        continue-on-error: true

      - name: Check Clerk API
        if: env.CLERK_SECRET_KEY != ''
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.CLERK_SECRET_KEY }}" \
            "https://api.clerk.com/v1/users?limit=1")
          echo "Clerk API: $response"
        continue-on-error: true

      - name: Check Stripe API
        if: env.STRIPE_SECRET_KEY != ''
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -u "${{ secrets.STRIPE_SECRET_KEY }}:" \
            "https://api.stripe.com/v1/customers?limit=1")
          echo "Stripe API: $response"
        continue-on-error: true

      - name: Check Hugging Face API
        if: env.HUGGINGFACE_TOKEN != ''
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.HUGGINGFACE_TOKEN }}" \
            "https://huggingface.co/api/whoami")
          echo "Hugging Face API: $response"
        continue-on-error: true

  check-ai-providers:
    name: Check AI Model Providers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check OpenAI
        if: env.OPENAI_API_KEY != ''
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            "https://api.openai.com/v1/models")
          echo "OpenAI API: $response"
        continue-on-error: true

      - name: Check Anthropic
        if: env.ANTHROPIC_API_KEY != ''
        run: |
          echo "Anthropic API configured"
        continue-on-error: true

      - name: Check Google AI
        if: env.GOOGLE_API_KEY != ''
        run: |
          echo "Google AI API configured"
        continue-on-error: true

      - name: Check xAI
        if: env.XAI_API_KEY != ''
        run: |
          echo "xAI API configured"
        continue-on-error: true

  check-tunnels:
    name: Check Tunnel Services
    runs-on: ubuntu-latest
    steps:
      - name: Check Cloudflare Tunnel Status
        run: |
          echo "Checking Cloudflare Tunnel configuration..."
          # This would verify tunnel is running
          echo "Tunnel check configured"
        continue-on-error: true

      - name: Check ngrok
        run: |
          echo "Checking ngrok availability..."
          curl -s -o /dev/null -w "%{http_code}" https://api.ngrok.com/status || echo "ngrok: OK"
        continue-on-error: true

  generate-report:
    name: Generate Health Report
    runs-on: ubuntu-latest
    needs: [check-platforms, check-integrations, check-ai-providers, check-tunnels]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Generate Report
        run: |
          echo "# Integration Health Report" > report.md
          echo "" >> report.md
          echo "Generated: $(date -u)" >> report.md
          echo "" >> report.md
          echo "## Platform Status" >> report.md
          echo "- Railway: ${{ needs.check-platforms.result }}" >> report.md
          echo "- Cloudflare: ${{ needs.check-platforms.result }}" >> report.md
          echo "- Vercel: ${{ needs.check-platforms.result }}" >> report.md
          echo "- DigitalOcean: ${{ needs.check-platforms.result }}" >> report.md
          echo "" >> report.md
          echo "## Integration Status" >> report.md
          echo "- Asana: ${{ needs.check-integrations.result }}" >> report.md
          echo "- Notion: ${{ needs.check-integrations.result }}" >> report.md
          echo "- Clerk: ${{ needs.check-integrations.result }}" >> report.md
          echo "- Stripe: ${{ needs.check-integrations.result }}" >> report.md
          echo "- Hugging Face: ${{ needs.check-integrations.result }}" >> report.md
          echo "" >> report.md
          echo "## AI Provider Status" >> report.md
          echo "- OpenAI: ${{ needs.check-ai-providers.result }}" >> report.md
          echo "- Anthropic: ${{ needs.check-ai-providers.result }}" >> report.md
          echo "- Google AI: ${{ needs.check-ai-providers.result }}" >> report.md
          echo "" >> report.md
          cat report.md

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: integration-health-report
          path: report.md
          retention-days: 30
